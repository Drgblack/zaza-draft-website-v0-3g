name: Build Resource Downloads (PR)

on:
  push:
    paths:
      - "public/resources/**.md"
      - "public/resources/**/meta.json"
      - "data/resources/resources.index.json"
      - "design/reference.docx"
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write         # needed for PR commits
      pull-requests: write    # needed to open PR
    steps:
      - uses: actions/checkout@v4

      - name: Install pandoc + PDF engine (tectonic)
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc tectonic

      - name: Convert MD -> DOCX/PDF (reference.docx optional)
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          REF_FLAG=""
          if [ -f design/reference.docx ]; then
            echo "Using reference.docx"
            REF_FLAG="--reference-doc=design/reference.docx"
          fi

          for meta in public/resources/*/meta.json; do
            dir=$(dirname "$meta")
            for lang in en de; do
              md="$dir/$lang.md"
              [ -f "$md" ] || continue
              mkdir -p "$dir/build"
              echo "Building $md → DOCX/PDF"
              pandoc "$md" --from=gfm --to=docx $REF_FLAG -o "$dir/build/$lang.docx"
              pandoc "$md" --from=gfm --pdf-engine=tectonic -o "$dir/build/$lang.pdf"
            done
          done

      - name: Create PR with generated files
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Build resources (docx/pdf)"
          branch: "ci/generated-resources"
          title: "Build resources (docx/pdf)"
          body: |
            Auto-generated by CI.
            - DOCX and PDFs created for all resources with available en.md/de.md
            - DOCX styled via design/reference.docx when present
          add-paths: |
            public/resources/*/build/*.docx
            public/resources/*/build/*.pdf
